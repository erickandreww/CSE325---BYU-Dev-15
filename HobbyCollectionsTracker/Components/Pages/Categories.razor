@page "/categories"
@* Only admins can manage categories *@
@attribute [Authorize(Roles = "Admin")]
@rendermode InteractiveServer
@* @using HobbyCollectionsTracker.Components.Layout
@layout MainLayout *@

@using HobbyCollectionsTracker.Data
@using HobbyCollectionsTracker.Models
@using Microsoft.EntityFrameworkCore
@inject ApplicationDbContext Db

<PageTitle>Categories - HCT</PageTitle>

@* Categories management page (Admin only) *@

<div class="hh-page-container">
  <h1 class="hh-page-title">Categories</h1>

  <div class="hh-surface">
    <div class="hh-surface-header">
      <div class="hh-surface-header-text">
        @* Short helper text for the admin *@
        Manage the list of categories that users can pick when creating posts.
      </div>

      <p class="mb-0">
        @* Link to the Create Category page *@
        <a class="btn btn-primary" href="/categories/create">Create New Category</a>
      </p>
    </div>

    @* Show any delete/error message to the admin *@
    @if (!string.IsNullOrEmpty(errorMessage))
    {
      <div class="alert alert-danger">
        @errorMessage
      </div>
    }

    @* Handle loading / empty / normal states *@
    @if (categories == null) @* this will show while categories load *@
    {
      <p>Loading...</p>
    }
    else if (!categories.Any()) @* If there are no categories yet *@
    {
      <p>No categories yet. Create one to get started.</p>
    }
    else @* If there are categories, show them in a table *@
    {
      <table class="table">
        <thead>
          <tr>
            <th>Name</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
        @foreach (var category in categories)
        {
          <tr>
            <td class="hh-table-category hh-wrap-anywhere">
              @category.Name
            </td>
            <td class="text-end">
              <a class="btn btn-sm btn-secondary"
                 href="/categories/edit/@category.Id">Edit</a>
              
              @* Delete removes the category from the database (with safety checks)*@
              <button class="btn btn-sm btn-danger ms-2"
                      @onclick="@(() => DeleteCategory(category.Id))">
                Delete
              </button>
            </td>
          </tr>
        }
        </tbody>
      </table>
    }
  </div>
</div>

@code {
  // List of all categories loaded from the database
  private List<Category>? categories;

  // Store a simple error message if delete fails
  private string? errorMessage;

  // Load categories from the database when the page is initialized
  protected override async Task OnInitializedAsync()
  {
    categories = await Db.Categories
      .OrderBy(c => c.Name)
      .ToListAsync();
  }

  // Delete a category by id and refresh the list
  private async Task DeleteCategory(int id)
  {
    errorMessage = null; // clear previous errors

    // First check if any posts are using this category.
    // If there are, we don't allow deleting it.
    var inUse = await Db.Posts.AnyAsync(p => p.CategoryId == id);
    if (inUse)
    {
      errorMessage = "You can't delete this category because there are posts using it. " +
        "Change or delete those posts first.";
      return;
    }

    // Look up the category in the database
    var category = await Db.Categories.FindAsync(id);
    if (category is null)
    {
      return;
    }

    try
    {
      // Remove from the database and save
      Db.Categories.Remove(category);
      await Db.SaveChangesAsync();

      // Reload the list so the UI stays in sync
      categories = await Db.Categories
        .OrderBy(c => c.Name)
        .ToListAsync();
    }
    catch (Exception ex)
    {
      // If something goes wrong (e.g., constraint issues), show a simple message
      errorMessage = $"Could not delete category: {ex.Message}";
    }
  }
}