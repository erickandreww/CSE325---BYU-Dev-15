@page "/categories/create"
@attribute [Authorize(Roles = "Admin")]
@rendermode InteractiveServer

@using System.ComponentModel.DataAnnotations
@using HobbyCollectionsTracker.Data
@using HobbyCollectionsTracker.Models
@using System.Threading.Tasks
@using Microsoft.EntityFrameworkCore
@inject ApplicationDbContext Db
@inject NavigationManager Nav

<PageTitle>Create Category - HCT</PageTitle>

@* Crete Category Page *@
<div class="hh-page-container">
  <h1 class="hh-page-title">Create Category</h1>

  <div class="hh-surface">
    @* Show duplicate-name or other errors *@
    @if (!string.IsNullOrEmpty(errorMessage))
    {
      <div class="alert alert-danger" role="alert">
        @errorMessage
      </div>
    }

    @* Form to Create a category *@
    <EditForm Model="@category" OnValidSubmit="HandleValidSubmit" class="hh-form-narrow">
      <DataAnnotationsValidator />
      <ValidationSummary />
      
      @* To insert the new category name *@
      <div class="mb-3 hh-form-row">
        <label for="name" class="form-label hh-field-label">Name</label>
        <div>
          <InputText id="name" class="form-control" @bind-Value="category.Name" />
          <ValidationMessage For="@(() => category.Name)" />
        </div>
      </div>
      
      @* Submit to database button *@
      <div class="hh-form-actions">
        <button type="submit" class="btn btn-primary">Save</button>
        <a class="btn btn-secondary ms-2" href="/categories">Cancel</a>
      </div>
    </EditForm>
  </div>
</div>

@code {
  private Category category = new();
  private string? errorMessage;

  // Called when the Create Post form passes validation.
  // Sets the current user as the owner of the post and saves it to the database.
  private async Task HandleValidSubmit()
  {
    errorMessage = null;

    // Normalize the name (trim spaces)
    category.Name = category.Name?.Trim() ?? string.Empty;

    if (string.IsNullOrWhiteSpace(category.Name))
    {
      errorMessage = "Name is required.";
      return;
    }

    // Check for duplicate name (case-insensitive by default in SQLite)
    var exists = await Db.Categories
      .AnyAsync(c => c.Name == category.Name);

    if (exists)
    {
      errorMessage = "A category with this name already exists. Please choose a different name.";
      return;
    }

    Db.Categories.Add(category);
    await Db.SaveChangesAsync();
    Nav.NavigateTo("/categories");
  }
}