@page "/posts/create"
@attribute [Authorize]
@rendermode InteractiveServer

@using HobbyCollectionsTracker.Data
@using HobbyCollectionsTracker.Models
@using Microsoft.EntityFrameworkCore
@using System.ComponentModel.DataAnnotations
@using System.Security.Claims
@using System.Threading.Tasks

@inject ApplicationDbContext Db
@inject NavigationManager Nav


<CascadingAuthenticationState>
  <h2>Create Post</h2>

  @if (categories == null) {
      <p>Loading...</p>
  }
  else if (!categories.Any()) {
    <div class="alert alert-warning">
      No categories found. Please ask an administrator to create categories first.
    </div>
  }
  else {
    <EditForm Model="@post" OnValidSubmit="HandleValidSubmit">
      <DataAnnotationsValidator />
      <ValidationSummary /> 

      <div class="mb-3">
        <label for="title" class="form-label">Title</label>
        <div>
          <InputText id="title" class="form-control"  @bind-Value="post.Title" />
          <ValidationMessage For="@(() => post.Title)" />
        </div>
      </div>

      <div class="mb-3">
        <label for="description" class="form-label">Description</label>
        <div>
          <InputTextArea id="description" class="form-control" rows="4" @bind-Value="post.Description" />
          <ValidationMessage For="@(() => post.Description)" />
        </div>
      </div>

      <div class="mb-3">
        <label for="category" class="form-label">Category</label>
        <div>
          <InputSelect id="category" class="form-select" @bind-Value="post.CategoryId">
            @foreach (var cat in categories) 
            {
              <option value="@cat.Id">@cat.Name</option>
            }
          </InputSelect>
          <ValidationMessage For="@(() => post.Title)" />
        </div>
      </div>

      <div class="mb-3">
        <label for="imageUrl" class="form-label">Image URL (optional)</label>
        <div>
          <InputText id="imageUrl" class="form-control"  @bind-Value="post.ImageUrl" />
          <div class="form-text">
            Paste a link to an existing image (for example, from an image host). Leave blank if you don't want an image.
          </div>
          <ValidationMessage For="@(() => post.ImageUrl)" />
        </div>
      </div>
      
      <button type="submit" class="btn btn-primary">Save</button>
      <a class="btn btn-secondary ms-2" href="/posts/mine">Cancel</a>
    </EditForm>
  }
</CascadingAuthenticationState>

@code {
  private Post post = new Post();
  private List<Category>? categories;

  [CascadingParameter]
  private Task<AuthenticationState> AuthenticationStateTask { get; set; } = default!;

  protected override async Task OnInitializedAsync()
  {
    categories = await Db.Categories
      .OrderBy(c => c.Name)
      .ToListAsync();

    if (categories.Any())
    {
      post.CategoryId = categories.First().Id;
    }
  }
  private async Task HandleValidSubmit(EditContext args)
  {
    var authState = await AuthenticationStateTask;
    var user = authState.User;

    if (!user.Identity?.IsAuthenticated ?? true)
    {
      Nav.NavigateTo("Identity/Account/Login", true);
      return;
    }

    var userId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;
    if (string.IsNullOrEmpty(userId))
    {
      return;
    }

    post.UserId = userId;
    post.CreatedAt = DateTime.UtcNow;

    Db.Posts.Add(post);
    await Db.SaveChangesAsync();

    Nav.NavigateTo("/posts/mine");
  }
}