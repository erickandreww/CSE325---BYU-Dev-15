@page "/posts/create"
@attribute [Authorize]
@rendermode InteractiveServer

@using HobbyCollectionsTracker.Data
@using HobbyCollectionsTracker.Models
@using Microsoft.EntityFrameworkCore
@using System.ComponentModel.DataAnnotations
@using System.Security.Claims
@using System.Threading.Tasks

@inject ApplicationDbContext Db
@inject NavigationManager Nav

<PageTitle>Create Post - HCT</PageTitle>

@* Create Post page *@
<CascadingAuthenticationState>
  <div class="hh-page-container">
    <h1 class="hh-page-title">Create Post</h1>

    <div class="hh-surface">
      @* Handle the different states for categories *@
      @if (categories == null)
      {
        @* Still loading categories from the database *@
        <p>Loading...</p>
      }
      else if (!categories.Any())
      {
        @* No categories at all = user canâ€™t create posts yet *@
        <div class="alert alert-warning mb-0">
          No categories found. Please ask an administrator to create categories first.
        </div>
      }
      else
      {
        @* Main form used to create a new post *@
        <EditForm Model="@post" OnValidSubmit="HandleValidSubmit" class="hh-form-narrow">
          <DataAnnotationsValidator />
          <ValidationSummary />

          @* Post Title *@
          <div class="mb-3 hh-form-row">
            <label for="title" class="form-label hh-field-label">Title</label>
            <div >
              <InputText id="title" class="form-control" @bind-Value="post.Title" />
              <ValidationMessage For="@(() => post.Title)" />
            </div>
          </div>

          @* Post Description *@
          <div class="mb-3 hh-form-row">
            <label for="description" class="form-label hh-field-label">Description</label>
            <div >
              <InputTextArea id="description" class="form-control" rows="4" @bind-Value="post.Description" />
              <ValidationMessage For="@(() => post.Description)" />
            </div>
          </div>

          @* Category dropdown (links to CategoryId on the Post) *@
          <div class="mb-3 hh-form-row">
            <label for="category" class="form-label hh-field-label">Category</label>
            <div >
              <InputSelect id="category" class="form-select" @bind-Value="post.CategoryId">
                @foreach (var cat in categories)
                {
                  <option value="@cat.Id">@cat.Name</option>
                }
              </InputSelect>
              <ValidationMessage For="@(() => post.CategoryId)" />
            </div>
          </div>

          @* Optional image URL (just a link, no upload) *@
          <div class="mb-3 hh-form-row">
            <label for="imageUrl" class="form-label hh-field-label">Image URL (optional)</label>
            <div >
              <InputText id="imageUrl" class="form-control" @bind-Value="post.ImageUrl" />
              <div class="form-text">
                Paste a link to an existing image (for example, from an image host).
                Leave blank if you don't want an image.
              </div>
              <ValidationMessage For="@(() => post.ImageUrl)" />
            </div>
          </div>

          @* Save/cancel actions *@
          <div class="hh-form-actions">
            <button type="submit" class="btn btn-primary">Save</button>
            <a class="btn btn-secondary ms-2" href="/posts/mine">Cancel</a>
          </div>
        </EditForm>
      }
    </div>
  </div>
</CascadingAuthenticationState>

@code {
  // Post being edited/created by this form
  private Post post = new Post();

  // Categories used to fill the dropdown
  private List<Category>? categories;

  // Gives access to the current logged-in user (Identity)
  [CascadingParameter]
  private Task<AuthenticationState> AuthenticationStateTask { get; set; } = default!;

  // When the page loads, grab all categories and set a default one
  protected override async Task OnInitializedAsync()
  {
    categories = await Db.Categories
      .OrderBy(c => c.Name)
      .ToListAsync();

    // If there are categories, preselect the first one
    if (categories.Any())
    {
      post.CategoryId = categories.First().Id;
    }
  }

  // Runs when the form passes validation and the user clicks Save
  // Here we attach the current user to the post and save it in the database
  private async Task HandleValidSubmit(EditContext args)
  {
    var authState = await AuthenticationStateTask;
    var user = authState.User;

    // If the user is not authenticated anymore, send to login
    if (!user.Identity?.IsAuthenticated ?? true)
    {
      Nav.NavigateTo("Identity/Account/Login", true);
      return;
    }

    // Get the Identity user id (used as foreign key on the Post)
    var userId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;
    if (string.IsNullOrEmpty(userId))
    {
      return;
    }

    // Set the owner and creation date
    post.UserId = userId;
    post.CreatedAt = DateTime.UtcNow;

    // Make ImageUrl optional (avoid null going to a NOT NULL column)
    if (string.IsNullOrWhiteSpace(post.ImageUrl))
    {
      post.ImageUrl = string.Empty;
    }

    // Add to the context and persist in the database
    Db.Posts.Add(post);
    await Db.SaveChangesAsync();

    // Go back to the list of posts for this user
    Nav.NavigateTo("/posts/mine");
  }
}