@page "/posts/mine"
@attribute [Authorize]
@rendermode InteractiveServer

@using HobbyCollectionsTracker.Models
@using HobbyCollectionsTracker.Data
@using Microsoft.EntityFrameworkCore
@using System.Security.Claims
@inject ApplicationDbContext Db
@inject NavigationManager Nav

<PageTitle>My Posts - HCT</PageTitle>

<CascadingAuthenticationState>
  @* My Posts page *@
  <div class="hh-page-container">

    <h1 class="hh-page-title">My Posts</h1>

    <div class="hh-surface">
      @* Handle loading and empty states *@
      @if (isLoading) {
        <p>Loading...</p>
      }
      else if (!posts.Any()){
        <p>
          You haven't created any posts yet. 
          <a href="/posts/create">Create your first post</a>
        </p>
      }
      else {
        @* Table with all posts owned by the current user *@
        <div class="table-responsive hh-my-posts-table">
          <table class="table align-middle">
            <thead>
              <tr>
                <th>Title</th>
                <th>Category</th>
                <th>Created</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
            @foreach (var post in posts) 
            {
              <tr>
                <td class="hh-table-category hh-wrap-anywhere">
                  <a href="/posts/details/@post.Id">
                    @post.Title
                  </a>
                </td>
                <td class="hh-table-category hh-wrap-anywhere">
                  @post.Category?.Name
                </td>
                <td class="hh-table-category hh-wrap-anywhere">
                  @post.CreatedAt.ToLocalTime().ToString("g")
                </td>
                <td class="text-end">
                  <a class="btn btn-sm btn-secondary" 
                     href="/posts/edit/@post.Id">
                    Edit
                  </a>
                  @* Delete removes the post after checking ownership again *@
                  <button class="btn btn-sm btn-danger ms-2"
                          @onclick="() => DeletePost(post.Id)">
                    Delete
                  </button>
                </td>
              </tr>
            }
            </tbody>
          </table>
        </div>
      }
    </div>
  
  </div>
</CascadingAuthenticationState>

@code {
  // List of posts that belong to the current user
  private List<Post> posts = new();

  // True while we're still loading data from the database
  private bool isLoading = true;
  
  // Used to get the current AuthenticationState with the logged-in user
  [CascadingParameter]
  private Task<AuthenticationState> AuthenticationStateTask { get; set; } = default!;
  
  // Make sure the user is logged in
  // Load only posts that belong to this user
  protected override async Task OnInitializedAsync()
  {
    var authState = await AuthenticationStateTask;
    var user = authState.User;

    if (!user.Identity?.IsAuthenticated ?? true)
    {
      Nav.NavigateTo("Identity/Account/Login", true);
      return;
    }

    var userId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;
    if (string.IsNullOrEmpty(userId))
    {
      Nav.NavigateTo("Identity/Account/Login", true);
      return;
    }

    posts = await Db.Posts
      .Where(p => p.UserId == userId)
      .Include(p => p.Category)
      .OrderByDescending(p => p.CreatedAt)
      .ToListAsync();

    isLoading = false; 
  }

  // Called when the user clicks Delete on a specific post.
  // re-check ownership on the server before actually deleting.
  private async Task DeletePost(int id)
  {
    var authState = await AuthenticationStateTask;
    var user = authState.User;
    var userId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;
    
    // Load the post from the database
    var post = await Db.Posts.FindAsync(id);
    // If the post doesn't exist or doesn't belong to this user
    if (post == null || post.UserId != userId)
    {
      return;
    }

    // Remove from database and save
    Db.Posts.Remove(post);
    await Db.SaveChangesAsync();

    // Also remove from the local list so the UI updates
    posts.RemoveAll(p => p.Id == id);
  }
}