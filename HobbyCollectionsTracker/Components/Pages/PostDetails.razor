@page "/posts/details/{Id:int}"
@rendermode InteractiveServer

@using HobbyCollectionsTracker.Models
@using HobbyCollectionsTracker.Data
@using Microsoft.EntityFrameworkCore
@inject ApplicationDbContext Db
@inject NavigationManager Nav

<PageTitle>Post Details - HCT</PageTitle>

@* Read-only Post Details page *@
<div class="hh-page-container">
  <h1 class="hh-page-title">Post Details</h1>

  @if (isLoading == true)
  {
    <p>Loading...</p>
  }
  else if (notFound == true)
  {
    @* Post id didn't match anything in the database *@
    <div class="alert alert-danger">
      Post not found.
    </div>
    <button class="btn btn-secondary" @onclick="GoBack">
      Back
    </button>
  }
  else
  {
    @* Main details card for the post *@
    <article class="hh-surface">
      <div class="row g-4 align-items-start">
        @* Left column: image *@
        <div class="col-12 col-lg-5">
          @* Show only if the post has an ImageUrl *@
          @if (!string.IsNullOrEmpty(post.ImageUrl)) @* The problem is here in post *@
          {
            <img src="@post.ImageUrl"
                 alt="@post.Title"
                 class="img-fluid rounded-4 w-100"
                 style="object-fit: cover; max-height: 480px;" />
          }
        </div>

        @* Right column: text details + actions *@
        <div class="col-12 col-lg-7 d-flex flex-column">
          <header class="mb-3">
            <nav aria-label="breadcrumb" class="small mb-1">
              <a href="/feed" class="text-decoration-none">Feed</a>
              <span class="text-muted"> Â· Post details</span>
            </nav>

            <h2 class="h3 mb-2">@post.Title</h2>

            <div class="d-flex flex-wrap align-items-center gap-2 mb-2">
              @if (!string.IsNullOrWhiteSpace(post.Category?.Name))
              {
                <span class="badge rounded-pill bg-primary-subtle text-primary small px-3 py-1">
                  @post.Category!.Name
                </span>
              }
              <span class="text-muted small">
                @post.CreatedAt.ToLocalTime().ToString("f")
              </span>
            </div>
          </header>

          <section class="flex-grow-1">
            <p class="mb-0">
              @post.Description
            </p>
          </section>

          @* Simple navigation buttons under the card *@
          <footer class="mt-4 d-flex flex-wrap gap-2">
            <button class="btn btn-secondary" type="button" @onclick="GoBack">
              Back
            </button>
            <a class="btn btn-primary" href="/feed">
              Go to Feed
            </a>
          </footer>
        </div>
      </div>
    </article>
  }
</div>


@code {
  // Id of the post
  [Parameter]
  public int Id { get; set; }

  // Post loaded (non-nullable, we assign only when found)
  private Post post = new();

  // Flags for UI state
  private bool isLoading = true;
  private bool notFound = false;

  // Grab the post (and its Category) from the DB
  protected override async Task OnInitializedAsync()
  {
    var loadedPost = await Db.Posts
      .Include(p => p.Category)
      .FirstOrDefaultAsync(p => p.Id == Id);

    if (loadedPost is null)
    {
      notFound = true;
    }
    else
    {
      post = loadedPost;
    }

    isLoading = false;
  }

  // Simple "back" behavior: for now just send the user to the feed
  private void GoBack()
  {
    Nav.NavigateTo("/feed");
  }
}