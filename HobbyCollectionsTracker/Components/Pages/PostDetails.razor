@page "/posts/details/{Id:int}"
@rendermode InteractiveServer

@using HobbyCollectionsTracker.Models
@using HobbyCollectionsTracker.Data
@using Microsoft.EntityFrameworkCore
@using System.Security.Claims
@inject ApplicationDbContext Db
@inject NavigationManager Nav

<PageTitle>Post Details - HCT</PageTitle>

@* Read-only Post Details page *@
<div class="hh-page-container">
    <h1 class="hh-page-title">Post Details</h1>

    @if (isLoading == true)
    {
        <p>Loading...</p>
    }
    else if (notFound == true)
    {
        @* Post id didn't match anything in the database *@
        <div class="alert alert-danger">
            Post not found.
        </div>
        <button class="btn btn-secondary" @onclick="GoBack">
            Back
        </button>
    }
    else
    {
        @* Main details card for the post *@
        <div class="hh-surface hh-section-card--narrow hh-post-details-card">
            <div class="hh-post-details">
                <section class="hh-post-header">
                    @* Show only if the post has an ImageUrl *@
                    @if (!string.IsNullOrEmpty(post.ImageUrl))
                    {
                        <figure class="hh-post-hero mb-0">
                            <img src="@post.ImageUrl"
                                 alt="@post.Title"
                                 class="hh-post-hero-img" />
                        </figure>
                    }

                    <div class="hh-post-header-text">
                        <div class="hh-post-breadcrumb">
                            <a href="/feed">Feed</a> · Post details
                        </div>

                        <h2 class="hh-post-title">@post.Title</h2>

                        <div class="hh-post-meta">
                            @if (!string.IsNullOrWhiteSpace(post.Category?.Name))
                            {
                                <span class="hh-post-category-pill">
                                    @post.Category!.Name
                                </span>
                            }

                            @* Show the author of the post *@
                            @if (!string.IsNullOrWhiteSpace(authorDisplayName))
                            {
                                <span class="hh-post-author">
                                    by @authorDisplayName
                                </span>
                            }

                            <span class="hh-post-date">
                                @post.CreatedAt.ToLocalTime().ToString("f")
                            </span>
                            <span class="hh-post-likes">
                                • @likeCount @((likeCount == 1) ? "like" : "likes")
                            </span>
                        </div>
                    </div>
                </section>

                <section class="hh-post-body mt-3">
                    <p class="card-text mb-0">@post.Description</p>
                </section>

                @* Like / Unlike button *@
                <section class="hh-post-actions mt-3">
                    @if (isAuthenticated)
                    {
                        <div>
                            <button class="btn btn-outline-primary me-2"
                                    @onclick="ToggleLike">
                                @(isLiked ? "♥ Liked" : "♡ Like")
                            </button>
                            <span class="small hh-post-likes-summary">
                                @likeCount @((likeCount == 1) ? "person likes this" : "people like this")
                            </span>
                        </div>
                    }
                    else
                    {
                        <span class="small hh-post-likes-summary">
                            @likeCount @((likeCount == 1) ? "like" : "likes") ·
                            <a href="Account/Login">Log in</a> to like this post.
                        </span>
                    }
                </section>
            </div>
        </div>

        @* Simple navigation buttons under the card *@
        <div class="mt-3 d-flex gap-2">
            <button class="btn btn-secondary" @onclick="GoBack">
                Back
            </button>
            <a class="btn btn-primary" href="/feed">
                Go to Feed
            </a>
        </div>
    }
</div>


@code {
    // Id of the post
    [Parameter]
    public int Id { get; set; }

    // Post loaded (non-nullable, we assign only when found)
    private Post post = new();

    // Name or email of the user who created the post
    private string? authorDisplayName;

    // Flags for UI state
    private bool isLoading = true;
    private bool notFound = false;

    // Like-related state
    private int likeCount;
    private bool isLiked;
    private bool isAuthenticated;

    // Access current user
    [CascadingParameter]
    private Task<AuthenticationState> AuthenticationStateTask { get; set; } = default!;

    // Grab the post (and its Category) from the DB
    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateTask;
        var user = authState.User;
        isAuthenticated = user.Identity?.IsAuthenticated ?? false;

        var userId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;

        var loadedPost = await Db.Posts
            .Include(p => p.Category)
            .Include(p => p.Likes)
            .FirstOrDefaultAsync(p => p.Id == Id);

        if (loadedPost is null)
        {
            notFound = true;
        }
        else
        {
            post = loadedPost;
            likeCount = post.Likes.Count;

            // Load the creator's display name from Identity
            if (!string.IsNullOrEmpty(post.UserId))
            {
                authorDisplayName = await Db.Users
                    .Where(u => u.Id == post.UserId)
                    .Select(u => u.UserName ?? u.Email)
                    .FirstOrDefaultAsync();

                if (string.IsNullOrWhiteSpace(authorDisplayName))
                {
                    authorDisplayName = "Unknown user";
                }
            }

            if (isAuthenticated && !string.IsNullOrEmpty(userId))
            {
                isLiked = post.Likes.Any(l => l.UserId == userId);
            }
        }

        isLoading = false;
    }

    // Simple "back" behavior: for now just send the user to the feed
    private void GoBack()
    {
        Nav.NavigateTo("/feed");
    }

    private async Task ToggleLike()
    {
        if (!isAuthenticated)
        {
            Nav.NavigateTo("Account/Login", true);
            return;
        }

        var authState = await AuthenticationStateTask;
        var user = authState.User;
        var userId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;

        if (string.IsNullOrEmpty(userId) || post.Id == 0)
        {
            return;
        }

        var existing = await Db.PostLikes
            .FirstOrDefaultAsync(l => l.PostId == post.Id && l.UserId == userId);

        if (existing is null)
        {
            Db.PostLikes.Add(new PostLike
            {
                PostId = post.Id,
                UserId = userId,
                CreatedAt = DateTime.UtcNow
            });

            isLiked = true;
            likeCount++;
        }
        else
        {
            Db.PostLikes.Remove(existing);
            isLiked = false;
            likeCount = Math.Max(0, likeCount - 1);
        }

        await Db.SaveChangesAsync();
    }
}