@page "/categories/edit/{Id:int}"
@attribute [Authorize(Roles = "Admin")]
@rendermode InteractiveServer

@using System.ComponentModel.DataAnnotations
@using HobbyCollectionsTracker.Data
@using HobbyCollectionsTracker.Models
@using System.Threading.Tasks
@using Microsoft.EntityFrameworkCore
@inject ApplicationDbContext Db
@inject NavigationManager Nav

<PageTitle>Edit Category - HCT</PageTitle>

@* Edit Category Page *@
<div class="hh-page-container">
  <h1 class="hh-page-title">Edit Category</h1>

  <div class="hh-surface">
    @if (!string.IsNullOrEmpty(errorMessage))
    {
      <div class="alert alert-danger" role="alert">
        @errorMessage
      </div>
    }

    @if (category == null) {
      <p>Loading...</p>
    }
    else {
      @* Form to Edit the selected category *@
      <EditForm Model="@category" OnValidSubmit="HandleValidSubmit" class="hh-form-narrow">
        <DataAnnotationsValidator/>
        <ValidationSummary/>
        
        <div class="mb-3 hh-form-row">
          <label for="name" class="form-label hh-field-label">Name</label>
          <div>
            <InputText id="name" class="form-control" @bind-Value="category.Name" />
            <ValidationMessage For="@(() => category.Name)" />
          </div>
        </div>

        @* Submit edit to database button *@
        <div class="hh-form-actions">
          <button type="submit" class="btn btn-primary">Save</button>
          <a class="btn btn-secondary ms-2" href="/categories">Cancel</a>
        </div>
      </EditForm>
    }
  </div>
</div>

@code {
  [Parameter]
  public int Id { get; set; }

  public Category? category;
  private string? errorMessage;
  
  // Get the category
  protected override async Task OnInitializedAsync()
  {
    category = await Db.Categories.FindAsync(Id);
    if (category == null) {
      Nav.NavigateTo("/categories");
    }
  }

  // Sets the current alteration and saves it to the Database
  private async Task HandleValidSubmit(EditContext args)
  {
    if (category is null)
    {
      return;
    }

    errorMessage = null;

    // Normalize the name
    category.Name = category.Name?.Trim() ?? string.Empty;

    if (string.IsNullOrWhiteSpace(category.Name))
    {
      errorMessage = "Name is required.";
      return;
    }

    // Check duplicates, ignoring this category's own Id
    var exists = await Db.Categories
      .AnyAsync(c => c.Id != category.Id && c.Name == category.Name);

    if (exists)
    {
      errorMessage = "A category with this name already exists. Please choose a different name.";
      return;
    }

    await Db.SaveChangesAsync();
    Nav.NavigateTo("/categories");
  }
}