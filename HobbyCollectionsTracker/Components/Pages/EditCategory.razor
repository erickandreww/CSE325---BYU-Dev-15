@page "/categories/edit/{Id:int}"
@attribute [Authorize(Roles = "Admin")]
@rendermode InteractiveServer

@using System.ComponentModel.DataAnnotations
@using HobbyCollectionsTracker.Data
@using HobbyCollectionsTracker.Models
@using System.Threading.Tasks
@inject ApplicationDbContext Db
@inject NavigationManager Nav

@* Edit Category Page *@
<div class="hh-page-container">
  <h1 class="hh-page-title">Edit Category</h1>

  <div class="hh-surface">
    @if (category == null) {
      <p>Loading...</p>
    }
    else {
      @* Form to Edit the selected category *@
      <EditForm Model="@category" OnValidSubmit="HandleValidSubmit" class="hh-form-narrow">
        <DataAnnotationsValidator/>
        <ValidationSummary/>
        
        <div class="mb-3">
          <label for="name" class="form-label">Name</label>
          <div>
            <InputText id="name" class="form-control" @bind-Value="category.Name" />
            <ValidationMessage For="@(() => category.Name)" />
          </div>
        </div>

        @* Submit edit to database button *@
        <button type="submit" class="btn btn-primary">Save</button>
        <a class="btn btn-secondary ms-2" href="/categories">Cancel</a>
      </EditForm>
    }
  </div>
</div>

@code {
  [Parameter]
  public int Id { get; set; }

  public Category? category;
  
  // Get the category
  protected override async Task OnInitializedAsync()
  {
    category = await Db.Categories.FindAsync(Id);
    if (category == null) {
      Nav.NavigateTo("/categories");
    }
  }

  // Sets the current alteration and saves it to the Database
  private async Task HandleValidSubmit(EditContext args)
  {
    await Db.SaveChangesAsync();
    Nav.NavigateTo("/categories");
  }
}