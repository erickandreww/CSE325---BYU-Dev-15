@page "/posts/edit/{Id:int}"
@attribute [Authorize]
@rendermode InteractiveServer

@using System.ComponentModel.DataAnnotations
@using HobbyCollectionsTracker.Data
@using HobbyCollectionsTracker.Models
@using Microsoft.EntityFrameworkCore
@using System.Security.Claims
@using System.Threading.Tasks

@inject ApplicationDbContext Db
@inject NavigationManager Nav

@* Edit Post page *@
<CascadingAuthenticationState>
  <div class="hh-page-container">
    <h2 class="hh-page-title">Edit Post</h2>

    <div class="hh-surface">
      @* Handle loading and error states first *@
      @if (isLoading) {
        <p>Loading...</p>
      }
      else if (notFound) {
        @* Either the post doesn't exist or doesn't belong to this user *@
        <div class="alert alert-danger">
          Post not found or you don't have permission to edit it.
        </div>
        <a class="btn btn-secondary" href="/posts/mine">Back to My Posts</a>
      }
      else if (post != null && categories != null) {
        @* Main edit form for an existing post *@
        <EditForm Model="@post" OnValidSubmit="HandleValidSubmit" class="hh-form-narrow">
          <DataAnnotationsValidator />
          <ValidationSummary /> 

          @* Title *@
          <div class="mb-3 hh-form-row">
            <label for="title" class="form-label hh-field-label">Title</label>
            <div >
              <InputText id="title" class="form-control"  @bind-Value="post.Title" />
              <ValidationMessage For="@(() => post.Title)" />
            </div>
          </div>

          @* Description *@
          <div class="mb-3 hh-form-row">
            <label for="description" class="form-label hh-field-label">Description</label>
            <div >
              <InputTextArea id="description" class="form-control" rows="4" 
                             @bind-Value="post.Description" />
              <ValidationMessage For="@(() => post.Description)" />
            </div>
          </div>

          @* Category dropdown (user can change the category) *@
          <div class="mb-3 hh-form-row">
            <label for="category" class="form-label hh-field-label">Category</label>
            <div >
              <InputSelect id="category" class="form-select" @bind-Value="post.CategoryId">
                @foreach (var cat in categories) 
                {
                  <option value="@cat.Id">@cat.Name</option>
                }
              </InputSelect>
              <ValidationMessage For="@(() => post.CategoryId)" />
            </div>
          </div>

          @* Optional image URL *@
          <div class="mb-3 hh-form-row">
            <label for="imageUrl" class="form-label hh-field-label">Image URL (optional)</label>
            <div >
              <InputText id="imageUrl" class="form-control"  @bind-Value="post.ImageUrl" />
              <ValidationMessage For="@(() => post.ImageUrl)" />
            </div>
          </div>

          @* Save changes or go back without saving *@
          <div class="hh-form-actions">
            <button type="submit" class="btn btn-primary">Save</button>
            <a class="btn btn-secondary ms-2" href="/posts/mine">Cancel</a>
          </div>
        </EditForm>
      }
    </div>
  </div>
</CascadingAuthenticationState>

@code {
  [Parameter]
  public int Id { get; set; }
  // The post being edited
  private Post? post;
  // All categories for the dropdown
  private List<Category>? categories;
  // Simple flags for UI state
  private bool isLoading = true;
  private bool notFound = false;

  // Gives access to the current logged-in user
  [CascadingParameter]
  private Task<AuthenticationState> AuthenticationStateTask { get; set; } = default!;

  // Check the user is logged in
  // Load categories
  // Load the post and make sure it belongs to this user
  protected override async Task OnInitializedAsync() {
    var authState = await AuthenticationStateTask;
    var user = authState.User;

    if (!user.Identity?.IsAuthenticated ?? true)
    {
      Nav.NavigateTo("Identity/Account/Login", true);
      return;
    }

    var userId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;
    if (string.IsNullOrEmpty(userId))
    {
      notFound = true;
      isLoading = false;
      return;
    }

    categories = await Db.Categories
      .OrderBy(c => c.Name)
      .ToListAsync();

    post = await Db.Posts.FindAsync(Id);

    if (post == null || post.UserId != userId)
    {
      notFound = true;
    }

    isLoading = false;
  }

  // When the form passes validation and the user clicks Save,
  // EF is already tracking the entity, so we just save changes.
  private async Task HandleValidSubmit(EditContext args)
  {
    await Db.SaveChangesAsync();
    Nav.NavigateTo("/posts/mine");
  }
}